<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æƒ…æ„Ÿæ ‡æ³¨ç³»ç»Ÿ - Mood Rater</title>
    <style>
        body {
            font-family: "Benton Sans", "Helvetica Neue", helvetica, arial, sans-serif;
            margin: 3em;
            padding: 20px;
            background: #f5f5f5;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .header h1 {
            font-family: 'Zilla Slab', serif;
            font-style: bold;
            font-size: xx-large;
            color: #373fff;
            margin-bottom: 10px;
        }
        .header h2 {
            font-style: italic;
            color: #6699ff;
        }
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 10px 10px 0;
            color: #1e3a8a;
        }
        .instructions li {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        .main-section {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        .player-section {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .va-section {
            position: relative;
            width: 550px; /* Increased width to accommodate labels */
            height: 500px; /* Fixed height for stability */
            margin: 0 auto;
        }

        .va-y-labels {
            position: absolute;
            left: 0;
            top: 45px; /* Vertically align with the canvas */
            width: 90px;
            height: 400px; /* Match canvas height */
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none; /* Make it non-interactive */
            z-index: 10; /* Ensure labels stay on top */
        }

        .va-canvas-container {
            position: absolute;
            left: 100px; /* Position it to the right of the labels */
            top: 0;
            width: 400px; /* Fixed width */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .va-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .y-label-fixed {
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
            user-select: none;
            line-height: 1.2;
        }

        .y-top { }
        .y-center { }
        .y-bottom { }
        .va-canvas-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .x-axis-labels {
            display: flex;
            justify-content: space-between;
            width: 400px;
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
            height: 40px; /* Fixed height */
            align-items: center;
            position: relative;
            z-index: 5; /* Keep labels on top */
        }
        .x-label {
            padding: 8px 0;
            user-select: none;
        }
        .va-canvas {
            border: 2px solid #333;
            border-radius: 10px;
            cursor: crosshair;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            /* ç¡®ä¿canvasä¸å½±å“å¸ƒå±€ */
            display: block;
            /* å›ºå®šcanvaså°ºå¯¸ï¼Œé˜²æ­¢ä»»ä½•å˜åŒ– */
            min-width: 400px;
            max-width: 400px;
            min-height: 400px;
            max-height: 400px;
            /* éš”ç¦»canvasé‡ç»˜ï¼Œé˜²æ­¢å½±å“å…¶ä»–å…ƒç´  */
            isolation: isolate;
            will-change: contents;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            /* é˜²æ­¢ä»»ä½•å¸ƒå±€åç§» */
            contain: layout style paint;
        }
        .current-emotion-display {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #373fff;
            margin-top: 5px;
            min-width: 300px;
            width: 400px; /* Fixed width to match canvas */
            min-height: 80px; /* Fixed minimum height */
            text-align: center;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .current-emotion-display #currentEmotion {
            font-weight: bold;
            font-size: 18px;
            color: #1e3a8a;
            margin-bottom: 5px;
            line-height: 1.4;
        }
        .current-emotion-display #coordinates {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-audio-time {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .history-emotion {
            font-weight: bold;
            color: #1e3a8a;
            font-size: 16px;
        }
        .history-coords {
            color: #374151;
            font-size: 14px;
            font-weight: 500;
        }
        .history-local-time {
            color: #6b7280;
            font-size: 12px;
        }
        .control-btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #373fff;
            color: white;
            cursor: pointer;
        }
        .control-btn:hover {
            background: #2a2fd8;
        }
        .va-labels {
            margin-top: 15px;
            font-size: 15px;
            color: #374151;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #1e3a8a;
        }
    </style>
</head>
<body>
    <div class="container">


        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>è¯·æ’­æ”¾ä¸‹é¢çš„éŸ³ä¹ç‰‡æ®µå¹¶æŠ¥å‘Šæ‚¨æ„ŸçŸ¥çš„æƒ…æ„Ÿå˜åŒ–</li>
                <li>æ¯å½“æ„ŸçŸ¥åˆ°æƒ…æ„Ÿå˜åŒ–æ—¶ï¼Œè¯·åŠæ—¶åœ¨VAç©ºé—´ä¸­è¿›è¡Œæ–°çš„æ ‡æ³¨</li>
                <li>ç‚¹å‡»VAç©ºé—´åä¼šæ˜¾ç¤ºç›¸å…³çš„æƒ…æ„Ÿæ ‡ç­¾ä½œä¸ºå‚è€ƒ</li>
                <li>æ¯ä¸ªéŸ³ä¹ç‰‡æ®µè‡³å°‘éœ€è¦5æ¬¡æ ‡æ³¨ï¼Œæœ€å¤šå¯è¾¾30æ¬¡æˆ–æ›´å¤š</li>
                <li>æ‚¨å¿…é¡»å®Œæ•´è†å¬éŸ³ä¹ç‰‡æ®µå¹¶åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­æä¾›æƒ…æ„Ÿè¯„åˆ†</li>
            </ul>
        </div>

        <div class="main-section">
            <div class="player-section">
                <h3>ğŸ¼ éŸ³ä¹æ’­æ”¾å™¨</h3>
                <audio id="audioPlayer" controls style="width: 100%; margin: 15px 0;">
                    <source src="https://cdn.jwplayer.com/videos/LCzPbzWR-rRek1hQx.m4a" type="audio/mpeg">
                </audio>
                <div>
                    <button class="control-btn" onclick="loadSampleMusic()">åŠ è½½ç¤ºä¾‹éŸ³ä¹</button>
                    <button class="control-btn" onclick="clearHistory()">æ¸…é™¤å†å²</button>
                    <button class="control-btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>

            <div class="va-section">
                <div class="va-y-labels">
                    <div class="y-label-fixed y-top">é«˜èƒ½é‡</div>
                    <div class="y-label-fixed y-center">Arousal<br>(å”¤é†’åº¦)</div>
                    <div class="y-label-fixed y-bottom">ä½èƒ½é‡</div>
                </div>

                <div class="va-canvas-container">
                    <div class="x-axis-labels">
                        <div class="x-label left">æ¶ˆæ</div>
                        <div class="x-label center">Valence (æ•ˆä»·)</div>
                        <div class="x-label right">ç§¯æ</div>
                    </div>
                    
                    <canvas id="vaCanvas" class="va-canvas" width="400" height="400"></canvas>
                    
                    <div class="current-emotion-display">
                        <div id="currentEmotion">è¯·ç‚¹å‡» VA ç©ºé—´è¿›è¡Œæ ‡æ³¨</div>
                        <div id="coordinates"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è½´è¯´æ˜ -->
        <div class="va-labels">
            <div style="margin-top: 10px; font-size: 14px; color: #374151; font-weight: 500;">
                å››ä¸ªè±¡é™: å·¦ä¸Š(æ„¤æ€’/ç´§å¼ ) | å³ä¸Š(å…´å¥‹/å¿«ä¹) | å·¦ä¸‹(æ‚²ä¼¤/ç–²æƒ«) | å³ä¸‹(å¹³é™/æ”¾æ¾)
            </div>
        </div>

        <div class="history-section">
            <h3>ğŸ“Š æ ‡æ³¨å†å²</h3>
            <div id="historyList">
                <div class="history-item">
                    <span>æš‚æ— æ ‡æ³¨è®°å½•</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 95ä¸ªæƒ…æ„Ÿæ ‡ç­¾æ•°æ® - åŸºäºAMGå’ŒANEWæ•°æ®é›†
        const emotionTags = [
            ['angry', 0.23, 0.77], ['bright', 0.81, 0.55], ['weary', 0.35, 0.35],
            ['tense', 0.32, 0.69], ['aggressive', 0.51, 0.60], ['romantic', 0.92, 0.82],
            ['hopeful', 0.76, 0.60], ['cold', 0.38, 0.52], ['ambitious', 0.83, 0.70],
            ['thoughtful', 0.83, 0.59], ['confident', 0.87, 0.65], ['cheerful', 0.89, 0.67],
            ['smooth', 0.70, 0.49], ['detached', 0.36, 0.41], ['elegant', 0.80, 0.44],
            ['bored', 0.24, 0.23], ['disappointment', 0.17, 0.45], ['discomfort', 0.15, 0.40],
            ['discouraged', 0.25, 0.44], ['sad', 0.08, 0.39], ['shamed', 0.19, 0.49],
            ['sorrow', 0.16, 0.44], ['anxiety', 0.22, 0.72], ['bad', 0.20, 0.57],
            ['harsh', 0.24, 0.58], ['anger', 0.17, 0.83], ['attack', 0.21, 0.75],
            ['danger', 0.24, 0.79], ['furious', 0.12, 0.83], ['horror', 0.22, 0.78],
            ['rage', 0.18, 0.90], ['stress', 0.14, 0.81], ['terrified', 0.09, 0.86],
            ['fatigued', 0.29, 0.21], ['tired', 0.29, 0.21], ['doubtful', 0.30, 0.41],
            ['indifferent', 0.45, 0.27], ['nonchalant', 0.47, 0.27], ['obstinate', 0.45, 0.37],
            ['preoccupied', 0.38, 0.49], ['skeptical', 0.44, 0.49], ['solemn', 0.42, 0.32],
            ['awkward', 0.28, 0.59], ['confused', 0.28, 0.63], ['envy', 0.30, 0.56],
            ['forceful', 0.36, 0.59], ['fright', 0.27, 0.60], ['haunt', 0.31, 0.70],
            ['obsessed', 0.33, 0.66], ['scary', 0.28, 0.71], ['suspicious', 0.35, 0.66],
            ['fight', 0.35, 0.77], ['panic', 0.27, 0.75], ['shock', 0.38, 0.81],
            ['quiet', 0.57, 0.23], ['decency', 0.60, 0.44], ['reverent', 0.54, 0.38],
            ['serious', 0.51, 0.38], ['challenge', 0.68, 0.68], ['complex', 0.53, 0.58],
            ['conquer', 0.73, 0.72], ['curious', 0.64, 0.60], ['eagerness', 0.65, 0.66],
            ['peaceful', 0.85, 0.23], ['relax', 0.86, 0.18], ['carefree', 0.82, 0.40],
            ['dignified', 0.76, 0.39], ['gentle', 0.79, 0.28], ['grateful', 0.80, 0.45],
            ['kindness', 0.85, 0.41], ['respectful', 0.78, 0.45], ['safe', 0.76, 0.36],
            ['secure', 0.82, 0.27], ['soft', 0.77, 0.45], ['wise', 0.82, 0.36],
            ['admire', 0.83, 0.65], ['amaze', 0.82, 0.74], ['care', 0.82, 0.63],
            ['competent', 0.76, 0.54], ['enjoy', 0.90, 0.67], ['funny', 0.95, 0.75],
            ['lust', 0.77, 0.74], ['strength', 0.80, 0.60], ['talent', 0.82, 0.66],
            ['desire', 0.84, 0.79], ['enthusiastic', 0.90, 0.80], ['excitement', 0.81, 0.83],
            ['joy', 0.95, 0.78], ['surprise', 0.84, 0.76], ['thrill', 0.88, 0.88],
            ['reserved', 0.49, 0.28], ['neutral', 0.50, 0.50], ['warm', 0.69, 0.52],
            ['tender', 0.74, 0.49], ['power', 0.69, 0.71], ['calm', 0.72, 0.33],
            ['positive', 0.88, 0.57]
        ];

        // ä¸­è‹±æ–‡æƒ…æ„Ÿæ ‡ç­¾å¯¹ç…§è¡¨
        const emotionTranslations = {
            'angry': 'æ„¤æ€’', 'bright': 'æ˜äº®', 'weary': 'ç–²æƒ«',
            'tense': 'ç´§å¼ ', 'aggressive': 'æ¿€æ˜‚', 'romantic': 'æµªæ¼«',
            'hopeful': 'å¸Œæœ›', 'cold': 'å†°å†·', 'ambitious': 'é›„å¿ƒ',
            'thoughtful': 'æ²‰æ€', 'confident': 'è‡ªä¿¡', 'cheerful': 'æ¬¢å¿«',
            'smooth': 'æµç•…', 'detached': 'è¶…ç„¶', 'elegant': 'ä¼˜é›…',
            'bored': 'åŒå€¦', 'disappointment': 'å¤±æœ›', 'discomfort': 'ä¸å®‰',
            'discouraged': 'æ²®ä¸§', 'sad': 'æ‚²ä¼¤', 'shamed': 'ç¾æ„§',
            'sorrow': 'å“€ä¼¤', 'anxiety': 'ç„¦è™‘', 'bad': 'é˜´éƒ',
            'harsh': 'åˆºè€³', 'anger': 'æš´æ€’', 'attack': 'å†²å‡»',
            'danger': 'å±é™©', 'furious': 'ç‹‚æ€’', 'horror': 'æƒŠéª‡',
            'rage': 'æš´æˆ¾', 'stress': 'å‹æŠ‘', 'terrified': 'ææƒ§',
            'fatigued': 'å€¦æ€ ', 'tired': 'ç–²ä¹', 'doubtful': 'ç–‘è™‘',
            'indifferent': 'æ·¡æ¼ ', 'nonchalant': 'æ¼ ç„¶', 'obstinate': 'å›ºæ‰§',
            'preoccupied': 'å¿§æ€', 'skeptical': 'æ€€ç–‘', 'solemn': 'è‚ƒç©†',
            'awkward': 'å±€ä¿ƒ', 'confused': 'å›°æƒ‘', 'envy': 'å¦’å¿Œ',
            'forceful': 'å¼ºéŸ§', 'fright': 'æƒŠæƒ¶', 'haunt': 'è¦ç»•',
            'obsessed': 'ç—´è¿·', 'scary': 'éª‡äºº', 'suspicious': 'çŒœç–‘',
            'fight': 'æŠ—äº‰', 'panic': 'ææ…Œ', 'shock': 'éœ‡æ’¼',
            'quiet': 'é™è°§', 'decency': 'åº„é‡', 'reverent': 'æ•¬ç•',
            'serious': 'ä¸¥è‚ƒ', 'challenge': 'æŒ‘æˆ˜', 'complex': 'ç¹å¤',
            'conquer': 'å¾æœ', 'curious': 'å¥½å¥‡', 'eagerness': 'æ¸´æœ›',
            'peaceful': 'å¹³å’Œ', 'relax': 'èˆ’ç¼“', 'carefree': 'æ— å¿§',
            'dignified': 'é›å®¹', 'gentle': 'è½»æŸ”', 'grateful': 'æ„Ÿæ©',
            'kindness': 'æ¸©æƒ…', 'respectful': 'è°¦æ­', 'safe': 'å®‰ç¨³',
            'secure': 'å®‰å¿ƒ', 'soft': 'æŸ”è½¯', 'wise': 'ç¿æ™º',
            'admire': 'å€¾æ…•', 'amaze': 'æƒŠå¹', 'care': 'å…³åˆ‡',
            'competent': 'å¹²ç»ƒ', 'enjoy': 'æ„‰æ‚¦', 'funny': 'è¯™è°',
            'lust': 'ç‚½çƒ­', 'strength': 'åŠ›é‡', 'talent': 'æ‰å',
            'desire': 'æ¸´æœ›', 'enthusiastic': 'çƒ­çƒˆ', 'excitement': 'æ¿€åŠ¨',
            'joy': 'æ¬¢æ¬£', 'surprise': 'æƒŠå¥‡', 'thrill': 'éœ‡é¢¤',
            'reserved': 'å«è“„', 'neutral': 'ä¸­æ€§', 'warm': 'æ¸©æš–',
            'tender': 'æ¸©æŸ”', 'power': 'æƒåŠ›', 'calm': 'æ²‰é™',
            'positive': 'ç§¯æ'
        };

        let canvas, ctx;
        let ratingHistory = [];
        let audioPlayer;
        let cleanCanvasImageData = null; // ç”¨äºå­˜å‚¨å¹²å‡€çš„Canvaså›¾åƒ

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initCanvas();
            initAudioPlayer();
            initEventListeners();
        });

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            canvas = document.getElementById('vaCanvas');
            ctx = canvas.getContext('2d');
            drawVASpace(); // é¦–æ¬¡ç»˜åˆ¶
            // æ•è·åˆå§‹ç»˜åˆ¶çš„å›¾åƒæ•°æ®ï¼Œç”¨äºå¿«é€Ÿæ¢å¤
            setTimeout(() => {
                cleanCanvasImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }, 0);
        }

        // ç»˜åˆ¶ VA ç©ºé—´èƒŒæ™¯ï¼ˆä¸åŒ…å«æ–‡å­—æ ‡ç­¾ï¼‰
        function drawVASpaceBackground() {
            const width = canvas.width;
            const height = canvas.height;
            
            // ä½¿ç”¨æ›´æ¸…æ™°çš„é¢œè‰²é…ç½®
            const tl = {r: 180, g: 0, b: 0};      // å·¦ä¸Š - æ·±çº¢è‰²
            const tr = {r: 220, g: 120, b: 0};    // å³ä¸Š - æ©™çº¢è‰²
            const bl = {r: 0, g: 40, b: 120};     // å·¦ä¸‹ - æ·±è“è‰²
            const br = {r: 120, g: 180, b: 60};   // å³ä¸‹ - ç»¿è‰²
            
            // é€åƒç´ ç»˜åˆ¶æ¸å˜èƒŒæ™¯
            for (let y = 0; y < height; y += 1) {
                const left = interpolateColor(tl, bl, y / height);
                const right = interpolateColor(tr, br, y / height);
                
                for (let x = 0; x < width; x += 1) {
                    const color = interpolateColor(left, right, x / width);
                    ctx.fillStyle = `rgb(${color.r}, ${color.g}, ${color.b})`;
                    ctx.fillRect(x, y, 1, 1);
                }
            }
            
            // ç»˜åˆ¶åæ ‡è½´ - æ›´ç²—æ›´æ¸…æ™°
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            
            // Xè½´ (Valence) - æ°´å¹³è½´
            ctx.beginPath();
            ctx.moveTo(0, height/2);
            ctx.lineTo(width, height/2);
            ctx.stroke();
            
            // Yè½´ (Arousal) - å‚ç›´è½´
            ctx.beginPath();
            ctx.moveTo(width/2, 0);
            ctx.lineTo(width/2, height);
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸­å¿ƒç‚¹
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(width/2, height/2, 4, 0, 2 * Math.PI);
            ctx.fill();
        }

        // ç»˜åˆ¶åæ ‡è½´æ–‡å­—æ ‡ç­¾ï¼ˆåªåœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰
        function drawVASpaceLabels() {
            const width = canvas.width;
            const height = canvas.height;
            
            // æ·»åŠ å››ä¸ªè±¡é™çš„è¯´æ˜
            ctx.font = '14px Arial';
            ctx.fillStyle = '#333';
            
            // å·¦ä¸Šè±¡é™ - æ¶ˆæé«˜èƒ½é‡
            ctx.fillText('æ„¤æ€’', 100, 100);
            ctx.fillText('ç´§å¼ ', 100, 120);
            
            // å³ä¸Šè±¡é™ - ç§¯æé«˜èƒ½é‡
            ctx.fillText('å…´å¥‹', width - 100, 100);
            ctx.fillText('å¿«ä¹', width - 100, 120);
            
            // å·¦ä¸‹è±¡é™ - æ¶ˆæä½èƒ½é‡
            ctx.fillText('æ‚²ä¼¤', 100, height - 120);
            ctx.fillText('ç–²æƒ«', 100, height - 100);
            
            // å³ä¸‹è±¡é™ - ç§¯æä½èƒ½é‡
            ctx.fillText('å¹³é™', width - 100, height - 120);
            ctx.fillText('æ”¾æ¾', width - 100, height - 100);
            
            // ä¸­å¿ƒç‚¹æ ‡ç­¾
            ctx.fillText('ä¸­æ€§', width/2, height/2 - 10);
        }

        // ç»˜åˆ¶å®Œæ•´çš„ VA ç©ºé—´ï¼ˆä»…åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
        function drawVASpace() {
            drawVASpaceBackground();
            drawVASpaceLabels();
        }

        // é¢œè‰²æ’å€¼å‡½æ•°
        function interpolateColor(a, b, x) {
            return {
                r: Math.floor(a.r + (b.r - a.r) * x),
                g: Math.floor(a.g + (b.g - a.g) * x),
                b: Math.floor(a.b + (b.b - a.b) * x)
            };
        }

        // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨
        function initAudioPlayer() {
            audioPlayer = document.getElementById('audioPlayer');
        }

        // è·å–éŸ³é¢‘å½“å‰æ—¶é—´
        function getVideoCurrentTime() {
            return audioPlayer.currentTime || 0;
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            canvas.addEventListener('click', handleCanvasClick);
        }

        // å¤„ç†ç”»å¸ƒç‚¹å‡»
        function handleCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // è½¬æ¢ä¸º VA åæ ‡ (0-1)
            const valence = x / canvas.width;
            const arousal = 1 - (y / canvas.height);
            
            // æ‰¾åˆ°é™„è¿‘çš„æƒ…æ„Ÿæ ‡ç­¾
            const nearbyEmotions = findNearbyEmotions(valence, arousal);
            addRating(valence, arousal, nearbyEmotions);
        }

        // æ‰¾åˆ°é™„è¿‘çš„æƒ…æ„Ÿæ ‡ç­¾
        function findNearbyEmotions(valence, arousal) {
            const circleRadius = canvas.width / 8; // 1/8 of VA interface width
            const nearbyEmotions = [];
            
            emotionTags.forEach(tag => {
                const [name, tagValence, tagArousal] = tag;
                const tagX = tagValence * canvas.width;
                const tagY = (1 - tagArousal) * canvas.height;
                const clickX = valence * canvas.width;
                const clickY = (1 - arousal) * canvas.height;
                
                const distance = Math.sqrt(
                    Math.pow(clickX - tagX, 2) + 
                    Math.pow(clickY - tagY, 2)
                );
                
                if (distance <= circleRadius) {
                    nearbyEmotions.push({
                        name: name,
                        distance: distance
                    });
                }
            });
            
            // æŒ‰è·ç¦»æ’åºï¼Œæœ€å¤šè¿”å›5ä¸ª
            nearbyEmotions.sort((a, b) => a.distance - b.distance);
            return nearbyEmotions.slice(0, 5);
        }

        // æ·»åŠ æ ‡æ³¨
        function addRating(valence, arousal, nearbyEmotions) {
            // è·å–éŸ³é¢‘å½“å‰æ—¶é—´æˆ³
            const timestamp = getVideoCurrentTime();
            const utcTimestamp = new Date().toISOString();
            
            const rating = {
                valence: valence,
                arousal: arousal,
                emotions: nearbyEmotions.map(e => e.name),
                timestamp: timestamp,
                utcTimestamp: utcTimestamp,
                time: new Date().toLocaleTimeString()
            };
            
            ratingHistory.push(rating);
            updateDisplay(rating);
            updateHistory();
            drawRatingPoint(valence, arousal);
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay(rating) {
            if (rating.emotions.length > 0) {
                // ç”Ÿæˆè‹±æ–‡æ ‡ç­¾
                const englishText = rating.emotions.join(', ') + ' (Guide Only)';
                
                // ç”Ÿæˆå¯¹åº”çš„ä¸­æ–‡ç¿»è¯‘
                const chineseText = rating.emotions.map(emotion => 
                    emotionTranslations[emotion] || emotion
                ).join('ã€') + 'ï¼ˆä»…ä¾›å‚è€ƒï¼‰';
                
                // æ˜¾ç¤ºè‹±æ–‡å’Œä¸­æ–‡
                document.getElementById('currentEmotion').innerHTML = 
                    englishText + '<br>' + chineseText;
            } else {
                // å¦‚æœæ²¡æœ‰æ ‡ç­¾è½åœ¨ç‚¹å‡»åŒºåŸŸå†…ï¼Œä¸æ˜¾ç¤ºä»»ä½•å¼•å¯¼æ ‡ç­¾
                document.getElementById('currentEmotion').innerHTML = 'æ— å¼•å¯¼æ ‡ç­¾<br>No guide tags in this area';
            }
            
            document.getElementById('coordinates').textContent = 
                `V: ${rating.valence.toFixed(3)}, A: ${rating.arousal.toFixed(3)}`;
        }

        function drawRatingPoint(valence, arousal) {
            // 1. å¿«é€Ÿæ¢å¤å¹²å‡€çš„canvasèƒŒæ™¯å’Œæ ‡ç­¾
            if (cleanCanvasImageData) {
                ctx.putImageData(cleanCanvasImageData, 0, 0);
            } else {
                // Fallback if the image data wasn't captured yet
                drawVASpace();
            }
            
            // 2. åœ¨å¹²å‡€çš„canvasä¸Šåªç»˜åˆ¶æ–°çš„ç‚¹
            const x = valence * canvas.width;
            const y = (1 - arousal) * canvas.height;

            // ç»˜åˆ¶æ–°çš„æ ‡è®°ç‚¹
            ctx.fillStyle = 'rgba(20, 20, 20, 0.9)'; // Darker, more visible point
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, 2 * Math.PI, true);
            ctx.fill();

            // æ·»åŠ ç™½è‰²è¾¹æ¡†ï¼Œä½¿å…¶æ›´çªå‡º
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // æ›´æ–°å†å²è®°å½• - å¼ºè°ƒéŸ³é¢‘æ—¶é—´
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            if (ratingHistory.length === 0) {
                historyList.innerHTML = '<div class="history-item"><span>æš‚æ— æ ‡æ³¨è®°å½•</span></div>';
                return;
            }
            
            historyList.innerHTML = ratingHistory.map((rating, index) => {
                let emotionDisplay;
                if (rating.emotions.length > 0) {
                    const englishText = rating.emotions.join(', ');
                    const chineseText = rating.emotions.map(emotion => 
                        emotionTranslations[emotion] || emotion
                    ).join('ã€') + 'ï¼ˆä»…ä¾›å‚è€ƒï¼‰';
                    emotionDisplay = `${englishText}<br><small style="color: #666;">${chineseText}</small>`;
                } else {
                    emotionDisplay = 'æ— å¼•å¯¼æ ‡ç­¾<br><small style="color: #666;">No guide tags in this area</small>';
                }
                
                return `
                <div class="history-item">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <span class="history-audio-time">ğŸµ ${formatTime(rating.timestamp)}</span>
                        <div>
                            <div class="history-emotion">${emotionDisplay}</div>
                            <div class="history-coords">V: ${rating.valence.toFixed(2)}, A: ${rating.arousal.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="history-local-time">
                        ${rating.time}
                    </div>
                </div>
                `;
            }).join('');
        }

        // åŠ è½½ç¤ºä¾‹éŸ³ä¹
        function loadSampleMusic() {
            const sampleMusic = [
                'https://cdn.jwplayer.com/videos/LCzPbzWR-rRek1hQx.m4a',
                'https://cdn.jwplayer.com/videos/ODXfHHU4-rRek1hQx.m4a',
                'https://cdn.jwplayer.com/videos/2DX7Zp4g-rRek1hQx.m4a'
            ];
            
            const randomMusic = sampleMusic[Math.floor(Math.random() * sampleMusic.length)];
            audioPlayer.src = randomMusic;
            audioPlayer.load();
        }

        // æ¸…é™¤å†å²
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ ‡æ³¨å†å²å—ï¼Ÿ')) {
                ratingHistory = [];
                updateHistory();
                document.getElementById('currentEmotion').textContent = 'è¯·ç‚¹å‡» VA ç©ºé—´è¿›è¡Œæ ‡æ³¨';
                document.getElementById('coordinates').textContent = '';
                // æ¸…é™¤ç‚¹å¹¶é‡ç»˜å¹²å‡€çš„VAç©ºé—´
                if (cleanCanvasImageData) {
                    ctx.putImageData(cleanCanvasImageData, 0, 0);
                } else {
                    drawVASpace();
                }
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (ratingHistory.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                totalRatings: ratingHistory.length,
                ratings: ratingHistory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mood-rating-${new Date().toISOString().slice(0, 19)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 