<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æƒ…æ„Ÿæ ‡æ³¨ç³»ç»Ÿ - Mood Rater</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            min-height: calc(100vh - 40px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header h2 {
            font-size: 1.2rem;
            color: #764ba2;
            font-weight: 400;
            font-style: italic;
        }

        .instructions {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .instructions h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ul {
            list-style: none;
            padding-left: 0;
        }

        .instructions li {
            color: #374151;
            line-height: 1.6;
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }

        .instructions li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .main-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-section {
                grid-template-columns: 1fr;
            }
        }

        .player-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .player-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .va-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .va-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }

        .va-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .va-y-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 400px;
            text-align: right;
            padding-right: 10px;
        }

        .y-label-fixed {
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
            user-select: none;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .va-canvas-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .x-axis-labels {
            display: flex;
            justify-content: space-between;
            width: 400px;
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
        }

        .x-label {
            user-select: none;
        }

        .va-canvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: crosshair;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: block;
            width: 400px;
            height: 400px;
        }

        .current-emotion-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #667eea;
            margin-top: 15px;
            width: 400px;
            min-height: 80px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .current-emotion-display #currentEmotion {
            font-weight: bold;
            font-size: 16px;
            color: #667eea;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .current-emotion-display #coordinates {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .history-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .history-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-audio-time {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 15px;
        }

        .history-emotion {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }

        .history-coords {
            color: #374151;
            font-size: 14px;
            font-weight: 500;
        }

        .history-local-time {
            color: #6b7280;
            font-size: 12px;
        }

        .control-btn {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .va-labels {
            margin-top: 20px;
            font-size: 14px;
            color: #374151;
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        audio {
            width: 100%;
            margin: 15px 0;
            border-radius: 10px;
        }

        .controls-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸµ éŸ³ä¹æƒ…æ„Ÿæ ‡æ³¨ç³»ç»Ÿ</h1>
            <h2>Music Emotion Annotation System</h2>
        </div>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>è¯·æ’­æ”¾ä¸‹é¢çš„éŸ³ä¹ç‰‡æ®µå¹¶æŠ¥å‘Šæ‚¨æ„ŸçŸ¥çš„æƒ…æ„Ÿå˜åŒ–</li>
                <li>æ¯å½“æ„ŸçŸ¥åˆ°æƒ…æ„Ÿå˜åŒ–æ—¶ï¼Œè¯·åŠæ—¶åœ¨VAç©ºé—´ä¸­è¿›è¡Œæ–°çš„æ ‡æ³¨</li>
                <li>ç‚¹å‡»VAç©ºé—´åä¼šæ˜¾ç¤ºç›¸å…³çš„æƒ…æ„Ÿæ ‡ç­¾ä½œä¸ºå‚è€ƒ</li>
                <li>æ¯ä¸ªéŸ³ä¹ç‰‡æ®µè‡³å°‘éœ€è¦5æ¬¡æ ‡æ³¨ï¼Œæœ€å¤šå¯è¾¾30æ¬¡æˆ–æ›´å¤š</li>
                <li>æ‚¨å¿…é¡»å®Œæ•´è†å¬éŸ³ä¹ç‰‡æ®µå¹¶åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­æä¾›æƒ…æ„Ÿè¯„åˆ†</li>
            </ul>
        </div>

        <div class="main-section">
            <div class="player-section">
                <h3>ğŸ¼ éŸ³ä¹æ’­æ”¾å™¨</h3>
                <audio id="audioPlayer" controls>
                    <source src="https://cdn.jwplayer.com/videos/LCzPbzWR-rRek1hQx.m4a" type="audio/mpeg">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                </audio>
                <div class="controls-wrapper">
                    <button class="control-btn" onclick="loadSampleMusic()">ğŸµ åŠ è½½ç¤ºä¾‹éŸ³ä¹</button>
                    <button class="control-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>
                    <button class="control-btn" onclick="exportData()">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>

            <div class="va-section">
                <h3>ğŸ¯ VA æƒ…æ„Ÿç©ºé—´æ ‡æ³¨</h3>
                <div class="va-container">
                    <div class="va-y-labels">
                        <div class="y-label-fixed">é«˜èƒ½é‡<br>High Arousal</div>
                        <div class="y-label-fixed">å”¤é†’åº¦<br>Arousal</div>
                        <div class="y-label-fixed">ä½èƒ½é‡<br>Low Arousal</div>
                    </div>

                    <div class="va-canvas-wrapper">
                        <div class="x-axis-labels">
                            <div class="x-label">æ¶ˆæ<br>Negative</div>
                            <div class="x-label">æ•ˆä»· Valence</div>
                            <div class="x-label">ç§¯æ<br>Positive</div>
                        </div>
                        
                        <canvas id="vaCanvas" class="va-canvas" width="400" height="400"></canvas>
                        
                        <div class="current-emotion-display">
                            <div id="currentEmotion">è¯·ç‚¹å‡» VA ç©ºé—´è¿›è¡Œæ ‡æ³¨</div>
                            <div id="coordinates"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="va-labels">
            <strong>å››ä¸ªè±¡é™è¯´æ˜ï¼š</strong>
            å·¦ä¸Š(æ„¤æ€’/ç´§å¼ ) | å³ä¸Š(å…´å¥‹/å¿«ä¹) | å·¦ä¸‹(æ‚²ä¼¤/ç–²æƒ«) | å³ä¸‹(å¹³é™/æ”¾æ¾)
        </div>

        <div class="history-section">
            <h3>ğŸ“Š æ ‡æ³¨å†å²</h3>
            <div id="historyList">
                <div class="history-item">
                    <span>æš‚æ— æ ‡æ³¨è®°å½•ï¼Œè¯·å¼€å§‹æ ‡æ³¨</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 95ä¸ªæƒ…æ„Ÿæ ‡ç­¾æ•°æ® - åŸºäºAMGå’ŒANEWæ•°æ®é›†
        const emotionTags = [
            ['angry', 0.23, 0.77], ['bright', 0.81, 0.55], ['weary', 0.35, 0.35],
            ['tense', 0.32, 0.69], ['aggressive', 0.51, 0.60], ['romantic', 0.92, 0.82],
            ['hopeful', 0.76, 0.60], ['cold', 0.38, 0.52], ['ambitious', 0.83, 0.70],
            ['thoughtful', 0.83, 0.59], ['confident', 0.87, 0.65], ['cheerful', 0.89, 0.67],
            ['smooth', 0.70, 0.49], ['detached', 0.36, 0.41], ['elegant', 0.80, 0.44],
            ['bored', 0.24, 0.23], ['disappointment', 0.17, 0.45], ['discomfort', 0.15, 0.40],
            ['discouraged', 0.25, 0.44], ['sad', 0.08, 0.39], ['shamed', 0.19, 0.49],
            ['sorrow', 0.16, 0.44], ['anxiety', 0.22, 0.72], ['bad', 0.20, 0.57],
            ['harsh', 0.24, 0.58], ['anger', 0.17, 0.83], ['attack', 0.21, 0.75],
            ['danger', 0.24, 0.79], ['furious', 0.12, 0.83], ['horror', 0.22, 0.78],
            ['rage', 0.18, 0.90], ['stress', 0.14, 0.81], ['terrified', 0.09, 0.86],
            ['fatigued', 0.29, 0.21], ['tired', 0.29, 0.21], ['doubtful', 0.30, 0.41],
            ['indifferent', 0.45, 0.27], ['nonchalant', 0.47, 0.27], ['obstinate', 0.45, 0.37],
            ['preoccupied', 0.38, 0.49], ['skeptical', 0.44, 0.49], ['solemn', 0.42, 0.32],
            ['awkward', 0.28, 0.59], ['confused', 0.28, 0.63], ['envy', 0.30, 0.56],
            ['forceful', 0.36, 0.59], ['fright', 0.27, 0.60], ['haunt', 0.31, 0.70],
            ['obsessed', 0.33, 0.66], ['scary', 0.28, 0.71], ['suspicious', 0.35, 0.66],
            ['fight', 0.35, 0.77], ['panic', 0.27, 0.75], ['shock', 0.38, 0.81],
            ['quiet', 0.57, 0.23], ['decency', 0.60, 0.44], ['reverent', 0.54, 0.38],
            ['serious', 0.51, 0.38], ['challenge', 0.68, 0.68], ['complex', 0.53, 0.58],
            ['conquer', 0.73, 0.72], ['curious', 0.64, 0.60], ['eagerness', 0.65, 0.66],
            ['peaceful', 0.85, 0.23], ['relax', 0.86, 0.18], ['carefree', 0.82, 0.40],
            ['dignified', 0.76, 0.39], ['gentle', 0.79, 0.28], ['grateful', 0.80, 0.45],
            ['kindness', 0.85, 0.41], ['respectful', 0.78, 0.45], ['safe', 0.76, 0.36],
            ['secure', 0.82, 0.27], ['soft', 0.77, 0.45], ['wise', 0.82, 0.36],
            ['admire', 0.83, 0.65], ['amaze', 0.82, 0.74], ['care', 0.82, 0.63],
            ['competent', 0.76, 0.54], ['enjoy', 0.90, 0.67], ['funny', 0.95, 0.75],
            ['lust', 0.77, 0.74], ['strength', 0.80, 0.60], ['talent', 0.82, 0.66],
            ['desire', 0.84, 0.79], ['enthusiastic', 0.90, 0.80], ['excitement', 0.81, 0.83],
            ['joy', 0.95, 0.78], ['surprise', 0.84, 0.76], ['thrill', 0.88, 0.88],
            ['reserved', 0.49, 0.28], ['neutral', 0.50, 0.50], ['warm', 0.69, 0.52],
            ['tender', 0.74, 0.49], ['power', 0.69, 0.71], ['calm', 0.72, 0.33],
            ['positive', 0.88, 0.57]
        ];

        // ä¸­è‹±æ–‡æƒ…æ„Ÿæ ‡ç­¾å¯¹ç…§è¡¨
        const emotionTranslations = {
            'angry': 'æ„¤æ€’', 'bright': 'æ˜äº®', 'weary': 'ç–²æƒ«',
            'tense': 'ç´§å¼ ', 'aggressive': 'æ¿€æ˜‚', 'romantic': 'æµªæ¼«',
            'hopeful': 'å¸Œæœ›', 'cold': 'å†°å†·', 'ambitious': 'é›„å¿ƒ',
            'thoughtful': 'æ²‰æ€', 'confident': 'è‡ªä¿¡', 'cheerful': 'æ¬¢å¿«',
            'smooth': 'æµç•…', 'detached': 'è¶…ç„¶', 'elegant': 'ä¼˜é›…',
            'bored': 'åŒå€¦', 'disappointment': 'å¤±æœ›', 'discomfort': 'ä¸å®‰',
            'discouraged': 'æ²®ä¸§', 'sad': 'æ‚²ä¼¤', 'shamed': 'ç¾æ„§',
            'sorrow': 'å“€ä¼¤', 'anxiety': 'ç„¦è™‘', 'bad': 'é˜´éƒ',
            'harsh': 'åˆºè€³', 'anger': 'æš´æ€’', 'attack': 'å†²å‡»',
            'danger': 'å±é™©', 'furious': 'ç‹‚æ€’', 'horror': 'æƒŠéª‡',
            'rage': 'æš´æˆ¾', 'stress': 'å‹æŠ‘', 'terrified': 'ææƒ§',
            'fatigued': 'å€¦æ€ ', 'tired': 'ç–²ä¹', 'doubtful': 'ç–‘è™‘',
            'indifferent': 'æ·¡æ¼ ', 'nonchalant': 'æ¼ ç„¶', 'obstinate': 'å›ºæ‰§',
            'preoccupied': 'å¿§æ€', 'skeptical': 'æ€€ç–‘', 'solemn': 'è‚ƒç©†',
            'awkward': 'å±€ä¿ƒ', 'confused': 'å›°æƒ‘', 'envy': 'å¦’å¿Œ',
            'forceful': 'å¼ºéŸ§', 'fright': 'æƒŠæƒ¶', 'haunt': 'è¦ç»•',
            'obsessed': 'ç—´è¿·', 'scary': 'éª‡äºº', 'suspicious': 'çŒœç–‘',
            'fight': 'æŠ—äº‰', 'panic': 'ææ…Œ', 'shock': 'éœ‡æ’¼',
            'quiet': 'é™è°§', 'decency': 'åº„é‡', 'reverent': 'æ•¬ç•',
            'serious': 'ä¸¥è‚ƒ', 'challenge': 'æŒ‘æˆ˜', 'complex': 'ç¹å¤',
            'conquer': 'å¾æœ', 'curious': 'å¥½å¥‡', 'eagerness': 'æ¸´æœ›',
            'peaceful': 'å¹³å’Œ', 'relax': 'èˆ’ç¼“', 'carefree': 'æ— å¿§',
            'dignified': 'é›å®¹', 'gentle': 'è½»æŸ”', 'grateful': 'æ„Ÿæ©',
            'kindness': 'æ¸©æƒ…', 'respectful': 'è°¦æ­', 'safe': 'å®‰ç¨³',
            'secure': 'å®‰å¿ƒ', 'soft': 'æŸ”è½¯', 'wise': 'ç¿æ™º',
            'admire': 'å€¾æ…•', 'amaze': 'æƒŠå¹', 'care': 'å…³åˆ‡',
            'competent': 'å¹²ç»ƒ', 'enjoy': 'æ„‰æ‚¦', 'funny': 'è¯™è°',
            'lust': 'ç‚½çƒ­', 'strength': 'åŠ›é‡', 'talent': 'æ‰å',
            'desire': 'æ¸´æœ›', 'enthusiastic': 'çƒ­çƒˆ', 'excitement': 'æ¿€åŠ¨',
            'joy': 'æ¬¢æ¬£', 'surprise': 'æƒŠå¥‡', 'thrill': 'éœ‡é¢¤',
            'reserved': 'å«è“„', 'neutral': 'ä¸­æ€§', 'warm': 'æ¸©æš–',
            'tender': 'æ¸©æŸ”', 'power': 'æƒåŠ›', 'calm': 'æ²‰é™',
            'positive': 'ç§¯æ'
        };

        let canvas, ctx;
        let ratingHistory = [];
        let audioPlayer;
        let cleanCanvasImageData = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initCanvas();
            initAudioPlayer();
            initEventListeners();
        });

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            console.log('åˆå§‹åŒ–ç”»å¸ƒ...');
            canvas = document.getElementById('vaCanvas');
            if (!canvas) {
                console.error('æ‰¾ä¸åˆ°canvaså…ƒç´ ');
                return;
            }
            ctx = canvas.getContext('2d');
            drawVASpace();
            setTimeout(() => {
                cleanCanvasImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                console.log('ç”»å¸ƒåˆå§‹åŒ–å®Œæˆ');
            }, 100);
        }

        // ç»˜åˆ¶ VA ç©ºé—´èƒŒæ™¯
        function drawVASpaceBackground() {
            const width = canvas.width;
            const height = canvas.height;
            
            // åˆ›å»ºæ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#ffebee');    // å·¦ä¸Š - æµ…çº¢
            gradient.addColorStop(0.25, '#fff3e0'); // å³ä¸Š - æµ…æ©™
            gradient.addColorStop(0.75, '#e8f5e8'); // å³ä¸‹ - æµ…ç»¿
            gradient.addColorStop(1, '#e3f2fd');    // å·¦ä¸‹ - æµ…è“
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // å‚ç›´ç½‘æ ¼çº¿
            for (let i = 1; i < 4; i++) {
                const x = (width / 4) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // æ°´å¹³ç½‘æ ¼çº¿
            for (let i = 1; i < 4; i++) {
                const y = (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶åæ ‡è½´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            
            // Xè½´ (Valence)
            ctx.beginPath();
            ctx.moveTo(0, height/2);
            ctx.lineTo(width, height/2);
            ctx.stroke();
            
            // Yè½´ (Arousal)
            ctx.beginPath();
            ctx.moveTo(width/2, 0);
            ctx.lineTo(width/2, height);
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸­å¿ƒç‚¹
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(width/2, height/2, 4, 0, 2 * Math.PI);
            ctx.fill();
        }

        // ç»˜åˆ¶åæ ‡è½´æ–‡å­—æ ‡ç­¾
        function drawVASpaceLabels() {
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            
            // å››ä¸ªè±¡é™çš„è¯´æ˜
            ctx.fillText('æ„¤æ€’/ç´§å¼ ', width * 0.25, 30);
            ctx.fillText('å…´å¥‹/å¿«ä¹', width * 0.75, 30);
            ctx.fillText('æ‚²ä¼¤/ç–²æƒ«', width * 0.25, height - 15);
            ctx.fillText('å¹³é™/æ”¾æ¾', width * 0.75, height - 15);
            
            // ä¸­å¿ƒç‚¹æ ‡ç­¾
            ctx.fillText('ä¸­æ€§', width/2, height/2 - 10);
        }

        // ç»˜åˆ¶å®Œæ•´çš„ VA ç©ºé—´
        function drawVASpace() {
            if (!ctx) return;
            drawVASpaceBackground();
            drawVASpaceLabels();
        }

        // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨
        function initAudioPlayer() {
            console.log('åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾å™¨...');
            audioPlayer = document.getElementById('audioPlayer');
            if (!audioPlayer) {
                console.error('æ‰¾ä¸åˆ°éŸ³é¢‘æ’­æ”¾å™¨å…ƒç´ ');
                return;
            }
            console.log('éŸ³é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // è·å–éŸ³é¢‘å½“å‰æ—¶é—´
        function getVideoCurrentTime() {
            return audioPlayer ? audioPlayer.currentTime || 0 : 0;
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            console.log('åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨...');
            if (canvas) {
                canvas.addEventListener('click', handleCanvasClick);
                console.log('ç”»å¸ƒç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨å·²æ·»åŠ ');
            }
        }

        // å¤„ç†ç”»å¸ƒç‚¹å‡»
        function handleCanvasClick(event) {
            console.log('ç”»å¸ƒè¢«ç‚¹å‡»');
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // è½¬æ¢ä¸º VA åæ ‡ (0-1)
            const valence = x / canvas.width;
            const arousal = 1 - (y / canvas.height);
            
            console.log(`ç‚¹å‡»åæ ‡: V=${valence.toFixed(3)}, A=${arousal.toFixed(3)}`);
            
            // æ‰¾åˆ°é™„è¿‘çš„æƒ…æ„Ÿæ ‡ç­¾
            const nearbyEmotions = findNearbyEmotions(valence, arousal);
            addRating(valence, arousal, nearbyEmotions);
        }

        // æ‰¾åˆ°é™„è¿‘çš„æƒ…æ„Ÿæ ‡ç­¾
        function findNearbyEmotions(valence, arousal) {
            const circleRadius = 0.15; // 15% of VA space
            const nearbyEmotions = [];
            
            emotionTags.forEach(tag => {
                const [name, tagValence, tagArousal] = tag;
                const distance = Math.sqrt(
                    Math.pow(valence - tagValence, 2) + 
                    Math.pow(arousal - tagArousal, 2)
                );
                
                if (distance <= circleRadius) {
                    nearbyEmotions.push({
                        name: name,
                        distance: distance
                    });
                }
            });
            
            // æŒ‰è·ç¦»æ’åºï¼Œæœ€å¤šè¿”å›3ä¸ª
            nearbyEmotions.sort((a, b) => a.distance - b.distance);
            return nearbyEmotions.slice(0, 3);
        }

        // æ·»åŠ æ ‡æ³¨
        function addRating(valence, arousal, nearbyEmotions) {
            const timestamp = getVideoCurrentTime();
            const utcTimestamp = new Date().toISOString();
            
            const rating = {
                valence: valence,
                arousal: arousal,
                emotions: nearbyEmotions.map(e => e.name),
                timestamp: timestamp,
                utcTimestamp: utcTimestamp,
                time: new Date().toLocaleTimeString()
            };
            
            ratingHistory.push(rating);
            console.log('æ·»åŠ æ–°æ ‡æ³¨:', rating);
            
            updateDisplay(rating);
            updateHistory();
            drawRatingPoint(valence, arousal);
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay(rating) {
            const emotionElement = document.getElementById('currentEmotion');
            const coordsElement = document.getElementById('coordinates');
            
            if (!emotionElement || !coordsElement) return;
            
            if (rating.emotions.length > 0) {
                const englishText = rating.emotions.join(', ');
                const chineseText = rating.emotions.map(emotion => 
                    emotionTranslations[emotion] || emotion
                ).join('ã€');
                
                emotionElement.innerHTML = `${englishText}<br><small style="color: #764ba2;">${chineseText}</small>`;
            } else {
                emotionElement.innerHTML = 'æ— åŒ¹é…æ ‡ç­¾<br><small style="color: #764ba2;">No matching tags</small>';
            }
            
            coordsElement.textContent = `V: ${rating.valence.toFixed(3)}, A: ${rating.arousal.toFixed(3)}`;
        }

        // ç»˜åˆ¶æ ‡æ³¨ç‚¹
        function drawRatingPoint(valence, arousal) {
            if (cleanCanvasImageData) {
                ctx.putImageData(cleanCanvasImageData, 0, 0);
            } else {
                drawVASpace();
            }
            
            const x = valence * canvas.width;
            const y = (1 - arousal) * canvas.height;

            // ç»˜åˆ¶æ ‡æ³¨ç‚¹
            ctx.fillStyle = '#667eea';
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, 2 * Math.PI);
            ctx.fill();

            // æ·»åŠ ç™½è‰²è¾¹æ¡†
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // æ›´æ–°å†å²è®°å½•
        function updateHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (ratingHistory.length === 0) {
                historyList.innerHTML = '<div class="history-item"><span>æš‚æ— æ ‡æ³¨è®°å½•ï¼Œè¯·å¼€å§‹æ ‡æ³¨</span></div>';
                return;
            }
            
            historyList.innerHTML = ratingHistory.slice(-10).reverse().map((rating, index) => {
                let emotionDisplay;
                if (rating.emotions.length > 0) {
                    const englishText = rating.emotions.join(', ');
                    const chineseText = rating.emotions.map(emotion => 
                        emotionTranslations[emotion] || emotion
                    ).join('ã€');
                    emotionDisplay = `${englishText}<br><small style="color: #666;">${chineseText}</small>`;
                } else {
                    emotionDisplay = 'æ— åŒ¹é…æ ‡ç­¾<br><small style="color: #666;">No matching tags</small>';
                }
                
                return `
                <div class="history-item">
                    <div style="display: flex; align-items: center; flex: 1;">
                        <span class="history-audio-time">ğŸµ ${formatTime(rating.timestamp)}</span>
                        <div>
                            <div class="history-emotion">${emotionDisplay}</div>
                            <div class="history-coords">V: ${rating.valence.toFixed(2)}, A: ${rating.arousal.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="history-local-time">
                        ${rating.time}
                    </div>
                </div>
                `;
            }).join('');
        }

        // åŠ è½½ç¤ºä¾‹éŸ³ä¹
        function loadSampleMusic() {
            const sampleMusic = [
                'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                'https://cdn.jwplayer.com/videos/LCzPbzWR-rRek1hQx.m4a'
            ];
            
            const randomMusic = sampleMusic[Math.floor(Math.random() * sampleMusic.length)];
            if (audioPlayer) {
                audioPlayer.src = randomMusic;
                audioPlayer.load();
                console.log('åŠ è½½éŸ³ä¹:', randomMusic);
            }
        }

        // æ¸…é™¤å†å²
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ ‡æ³¨å†å²å—ï¼Ÿ')) {
                ratingHistory = [];
                updateHistory();
                document.getElementById('currentEmotion').innerHTML = 'è¯·ç‚¹å‡» VA ç©ºé—´è¿›è¡Œæ ‡æ³¨';
                document.getElementById('coordinates').textContent = '';
                
                if (cleanCanvasImageData) {
                    ctx.putImageData(cleanCanvasImageData, 0, 0);
                } else {
                    drawVASpace();
                }
                console.log('å†å²è®°å½•å·²æ¸…é™¤');
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (ratingHistory.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                totalRatings: ratingHistory.length,
                ratings: ratingHistory
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mood-rating-${new Date().toISOString().slice(0, 19)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('æ•°æ®å·²å¯¼å‡º');
        }

        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        window.addEventListener('load', function() {
            console.log('çª—å£åŠ è½½å®Œæˆ');
            console.log('Canvaså…ƒç´ :', document.getElementById('vaCanvas'));
            console.log('Audioå…ƒç´ :', document.getElementById('audioPlayer'));
        });
    </script>
</body>
</html>